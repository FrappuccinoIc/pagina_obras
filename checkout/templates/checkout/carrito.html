{% extends 'core/base.html' %}
{% load static %}

{% block contenido %}
<section class="container my-5">
    <h2 class="mb-4 text-center">Selección de Obras</h2>

    <div class="row">

        <!-- Obras clickeables -->
        <div class="col-lg-8">
            <div class="row g-4">

                {% for obra in obras %}
                <div class="col-md-6">
                    <div class="card obra-card" 
                         data-precio="{{ obra.precio }}" 
                         data-id="{{ obra.id }}"
                         style="cursor:pointer;">
                        <img src="{{ obra.imagen.url }}" class="card-img-top"
                             style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">{{ obra.titulo }}</h5>
                            <p class="text-muted mb-1">Precio: ${{ obra.precio }}</p>
                            <small class="text-muted">Click para agregar o quitar</small>
                        </div>
                    </div>
                </div>
                {% endfor %}

            </div>
        </div>

        <!-- Carrito (dinámico) -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 80px;">
                <div class="card-body">
                    <h5 class="card-title">Carrito</h5>

                    <ul id="lista-carrito" class="list-group mb-3"></ul>

                    <hr>
                    <h4>Total: $<span id="total">{{ monto_total }}</span></h4>

                    <button class="btn btn-success w-100 mt-3" disabled id="boton-pago">
                        Proceder al Pago
                    </button>
                </div>
            </div>
        </div>
    </div>

</section>

<!-- Script de agregar/quitar -->
<script>
    const obras = document.querySelectorAll(".obra-card");
    const lista = document.getElementById("lista-carrito");
    const totalSpan = document.getElementById("total");
    const botonPago = document.getElementById("boton-pago");

    let total = 0;

    // Mapa para saber qué obra está en el carrito
    const seleccionadas = new Map();

    obras.forEach(carta => {
        carta.addEventListener("click", () => {

            const id = carta.dataset.id;
            const precio = parseInt(carta.dataset.precio);
            const titulo = carta.querySelector(".card-title").innerText;

            // Si NO tiene, agregar
            if (!seleccionadas.has(id)) {

                // Crear item en lista
                const item = document.createElement("li");
                item.className = "list-group-item d-flex justify-content-between align-items-center";
                item.dataset.id = id;
                item.innerHTML = `
                    <span>${titulo}</span>
                    <strong>$${precio}</strong>
                `;

                lista.appendChild(item);

                seleccionadas.set(id, item);
                carta.classList.add("border", "border-success");

                total += precio;

            } else {
                // Si ya estaba, eliminar
                const item = seleccionadas.get(id);
                lista.removeChild(item);
                seleccionadas.delete(id);

                carta.classList.remove("border", "border-success");

                total -= precio;
            }

            totalSpan.textContent = total;
            botonPago.disabled = total === 0;
        });
    });
</script>
{% endblock %}
